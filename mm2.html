<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ê²½ë§¤ ë“œë˜í”„íŠ¸ (ë£°ë › ê¸°ëŠ¥ ì¶”ê°€)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .panel-box { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .slot-circle { width: 3rem; height: 3rem; border-radius: 50%; background-color: #334155; border: 2px dashed #64748b; display: flex; align-items: center; justify-content: center; color: #94a3b8; background-size: cover; background-position: center; }
        .slot-circle.drafted { border: 2px solid #4ade80; box-shadow: 0 0 8px rgba(74, 222, 128, 0.4); }
        .card-slot { height: 5rem; border-radius: 0.5rem; background-color: #334155; border: 2px solid #475569; background-size: cover; background-position: center; cursor: pointer; transition: all 0.2s; }
        .card-slot:hover { border-color: #fbbf24; transform: translateY(-2px); }

        /* íŒ€ ì „ìš© ì œì–´ */
        .only-captains { display: none !important; }
        body.role-team-a .only-captains, body.role-team-b .only-captains { display: block !important; }
        body.role-spectator .spectator-hide { display: none !important; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-overlay.show { display: flex; }
        
        /* ì±„íŒ… ìŠ¤íƒ€ì¼ */
        .chat-bubble { padding: 6px 10px; border-radius: 8px; margin-bottom: 4px; font-size: 0.85rem; max-width: 90%; word-break: break-all; }
        .chat-bubble.my { background-color: #4f46e5; margin-left: auto; color: white; }
        .chat-bubble.other { background-color: #334155; margin-right: auto; color: #cbd5e1; }
        .chat-badge { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; margin-right: 4px; font-weight: bold; }
        .badge-team-a { background-color: #7c3aed; color: white; }
        .badge-team-b { background-color: #2563eb; color: white; }
        .badge-spec { background-color: #475569; color: #cbd5e1; }

        /* ë£°ë › íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .roulette-active { animation: bounce 0.2s infinite; border-color: #fbbf24 !important; box-shadow: 0 0 20px #fbbf24; }

    </style>
</head>
<body class="p-4 max-w-7xl mx-auto h-screen flex flex-col">

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="modal-overlay show">
        <div class="bg-slate-800 border-2 border-purple-500 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <h2 class="text-3xl font-bold text-white mb-2">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p class="text-gray-400 mb-6">ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <div class="space-y-3">
                <button onclick="joinAs('team-a')" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl font-bold text-white text-lg hover:scale-[1.02] transition shadow-lg border border-purple-400/30">ğŸ¦ Team A íŒ€ì¥</button>
                <button onclick="joinAs('team-b')" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl font-bold text-white text-lg hover:scale-[1.02] transition shadow-lg border border-blue-400/30">ğŸ¯ Team B íŒ€ì¥</button>
                <button onclick="joinAs('spectator')" class="w-full py-4 bg-slate-700 rounded-xl font-bold text-gray-300 text-lg hover:bg-slate-600 transition">ğŸ¿ ê´€ì „ì</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
        
        <!-- [ì™¼ìª½] ê²½ë§¤ ë° í˜„í™© -->
        <div class="lg:col-span-2 flex flex-col gap-4 h-full overflow-y-auto">
            <!-- ì„¤ì • íŒ¨ë„ -->
            <div class="panel-box p-4 bg-slate-800/50 border-t-4 border-purple-500">
                <div class="flex justify-between items-center mb-2">
                    <div class="font-bold text-purple-400">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
                    <div class="spectator-hide flex gap-2">
                        <button onclick="updateSettingsDB()" class="bg-purple-600 px-3 py-1 rounded text-xs text-white font-bold">ì ìš©</button>
                        <button onclick="restartGameDB()" class="bg-yellow-600 px-3 py-1 rounded text-xs text-white font-bold">ì¬ì‹œì‘</button>
                        <button onclick="resetAllDB()" class="bg-red-600 px-3 py-1 rounded text-xs text-white font-bold">ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-xs text-gray-400 block">ì‹œì‘ í¬ì¸íŠ¸</label><input type="number" id="start-point-input" value="1000" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-sm"></div>
                    <div><label class="text-xs text-purple-400 block">Team A ì´ë¦„/ê°ë…</label><div class="flex gap-1"><input id="input-team-a-name" placeholder="íŒ€ëª…" class="w-1/2 bg-slate-900 border border-slate-600 rounded px-1 text-xs text-white"><input id="input-team-a-leader" placeholder="ê°ë…" class="w-1/2 bg-slate-900 border border-slate-600 rounded px-1 text-xs text-white"></div></div>
                    <div><label class="text-xs text-blue-400 block">Team B ì´ë¦„/ê°ë…</label><div class="flex gap-1"><input id="input-team-b-name" placeholder="íŒ€ëª…" class="w-1/2 bg-slate-900 border border-slate-600 rounded px-1 text-xs text-white"><input id="input-team-b-leader" placeholder="ê°ë…" class="w-1/2 bg-slate-900 border border-slate-600 rounded px-1 text-xs text-white"></div></div>
                </div>
            </div>

            <!-- í˜„í™©íŒ -->
            <div class="panel-box bg-[#111827]">
                <div class="bg-slate-800/80 p-2 border-b border-slate-700 font-bold text-white text-center">íŒ€ í˜„í™©</div>
                <div class="divide-y divide-slate-800">
                    <div class="p-3 flex items-center justify-between bg-slate-900/30"><div><div class="text-lg font-bold text-purple-400" id="display-team-a-name">-</div><div class="text-xs text-gray-500" id="display-team-a-leader">ê°ë…: -</div></div><div class="text-2xl font-mono font-bold text-green-400" id="display-team-a-point">1,000</div><div class="flex gap-1" id="slots-team-a"></div></div>
                    <div class="p-3 flex items-center justify-between bg-slate-900/30"><div><div class="text-lg font-bold text-blue-400" id="display-team-b-name">-</div><div class="text-xs text-gray-500" id="display-team-b-leader">ê°ë…: -</div></div><div class="text-2xl font-mono font-bold text-green-400" id="display-team-b-point">1,000</div><div class="flex gap-1" id="slots-team-b"></div></div>
                </div>
            </div>

             <!-- ëŒ€ê¸° ëª…ë‹¨ -->
             <div class="panel-box bg-slate-800 p-3 flex-grow">
                <div class="flex justify-between items-center mb-2">
                    <div class="font-bold text-yellow-400">ğŸ“¸ ì„ ìˆ˜ ëŒ€ê¸°ì‹¤</div>
                    <div class="spectator-hide flex gap-2">
                        <button onclick="runRoulette()" class="bg-pink-600 text-white text-xs px-3 py-1.5 rounded font-bold shadow-lg hover:bg-pink-500 transition transform active:scale-95 flex items-center">
                            <span class="mr-1">ğŸ°</span> ëœë¤ ë½‘ê¸° (Roulette)
                        </button>
                        <button onclick="document.getElementById('pool-file-input').click()" class="bg-slate-600 text-white text-xs px-3 py-1.5 rounded shadow">+ ì‚¬ì§„ ì¶”ê°€</button>
                    </div>
                </div>
                <div id="candidate-pool-container" class="grid grid-cols-6 gap-2 max-h-60 overflow-y-auto p-1"></div>
            </div>
        </div>

        <!-- [ì˜¤ë¥¸ìª½] ì±„íŒ… ë° ë¡œê·¸ -->
        <div class="lg:col-span-1 flex flex-col gap-4 h-full">
            <div class="panel-box h-1/3 flex flex-col">
                <div class="bg-slate-800 p-2 text-center text-xs font-bold text-gray-400 border-b border-slate-700">ğŸ”” ì‹œìŠ¤í…œ ë¡œê·¸</div>
                <div id="event-log-content" class="flex-grow overflow-y-auto p-2 text-xs text-gray-300 space-y-1 font-mono"><div id="loading-msg" class="text-center mt-4">ì ‘ì† ì¤‘...</div></div>
            </div>
            <div class="panel-box h-2/3 flex flex-col relative">
                <div class="bg-slate-800 p-2 text-center text-sm font-bold text-white border-b border-slate-700">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</div>
                <div id="chat-container" class="flex-grow overflow-y-auto p-3 space-y-2 bg-slate-900/50"></div>
                <div class="p-2 bg-slate-800 border-t border-slate-700 flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendChatDB()">
                    <button onclick="sendChatDB()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- [ì‹ ê·œ ê¸°ëŠ¥] ë£°ë › ëª¨ë‹¬ -->
    <div id="roulette-modal" class="modal-overlay">
        <div class="bg-slate-900 border-4 border-pink-500 p-8 rounded-3xl shadow-2xl max-w-md w-full text-center">
            <h2 class="text-3xl font-extrabold text-pink-400 mb-4 animate-pulse">ğŸ° ì¶”ì²¨ ì¤‘...</h2>
            <div class="w-64 h-64 mx-auto rounded-2xl bg-slate-800 border-4 border-slate-600 bg-cover bg-center mb-6 transition-all duration-75" id="roulette-img"></div>
            <p class="text-white font-bold text-lg">ì˜¤ëŠ˜ì˜ ì£¼ì¸ê³µì€ ëˆ„êµ¬?</p>
        </div>
    </div>

    <!-- [ê²½ë§¤ ëª¨ë‹¬] - í„´ ë°©ì‹ -->
    <div id="bidding-modal" class="modal-overlay">
        <div class="bg-slate-900 border-[3px] border-yellow-500 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center relative">
            <h3 class="text-2xl font-extrabold text-yellow-400 mb-2 mt-1 tracking-widest">AUCTION</h3>
            
            <!-- ì„ ìˆ˜ ì´ë¯¸ì§€ -->
            <div class="w-40 h-40 mx-auto rounded-xl bg-slate-800 mb-4 bg-cover bg-center border-4 border-slate-700 shadow-lg" id="bidding-player-img"></div>
            
            <!-- í˜„ì¬ ìµœê³  ì…ì°°ê°€ í‘œì‹œ -->
            <div class="bg-slate-800 p-4 rounded-lg mb-4 border border-slate-700 relative overflow-hidden">
                <div class="text-gray-400 text-xs mb-1 uppercase tracking-wider">Current Bid (Highest)</div>
                <div id="display-bid-price" class="text-5xl font-mono font-bold text-green-400 drop-shadow-md">0</div>
                <div id="high-bidder-badge" class="absolute top-2 right-2 px-2 py-1 bg-gray-700 text-[10px] rounded text-white">None</div>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ -->
            <div class="only-captains space-y-3">
                <div id="controls-locked" class="hidden p-3 bg-slate-800/50 rounded border border-slate-700">
                    <p class="text-yellow-400 font-bold animate-pulse">ğŸ‘‘ í˜„ì¬ ìµœê³  ì…ì°°ìì…ë‹ˆë‹¤!</p>
                    <p class="text-xs text-gray-400 mt-1">ìƒëŒ€ë°©ì˜ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                </div>

                <div id="controls-active" class="hidden space-y-3">
                    <div class="flex gap-2 items-center bg-slate-800 p-2 rounded border border-slate-600">
                        <span class="text-white text-sm font-bold whitespace-nowrap pl-2">â‚©</span>
                        <input type="number" id="manual-bid-input" class="w-full bg-transparent text-white font-bold text-xl outline-none text-right pr-2" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    </div>
                    <button onclick="submitManualBid()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded-lg font-bold text-lg shadow transition active:scale-95">
                        ğŸ”¼ ì…ì°° í•˜ê¸° (Bid)
                    </button>
                    
                    <div id="accept-btns-area" class="grid grid-cols-1 gap-2 mt-2">
                        <button id="btn-accept-a" onclick="finishBiddingDB('teamA')" class="hidden w-full bg-slate-700 hover:bg-green-600 text-white py-3 rounded font-bold border border-slate-500 transition">
                            âœ… AíŒ€ ë‚™ì°° ì¸ì •í•˜ê¸° (í¬ê¸°)
                        </button>
                        <button id="btn-accept-b" onclick="finishBiddingDB('teamB')" class="hidden w-full bg-slate-700 hover:bg-green-600 text-white py-3 rounded font-bold border border-slate-500 transition">
                            âœ… BíŒ€ ë‚™ì°° ì¸ì •í•˜ê¸° (í¬ê¸°)
                        </button>
                    </div>
                </div>
                
                <button onclick="cancelBiddingDB()" class="w-full border border-slate-600 text-gray-400 hover:text-white py-2 rounded text-xs mt-2">
                    ğŸš« ê²½ë§¤ ì·¨ì†Œ / ë„˜ê¸°ê¸°
                </button>
            </div>
            
            <div class="spectator-hide-inverse text-center mt-4 text-gray-500 text-sm">
                ê°ë…ë‹˜ë“¤ì´ ê°€ê²©ì„ ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <input type="file" id="pool-file-input" accept="image/*" multiple class="hidden">

    <script>
        var myRole = 'spectator'; 
        var globalState = null; 
        var db = null;
        var docRef = null;

        const firebaseConfig = {
            apiKey: "AIzaSyA984OYNlklrVECe4zDAWIxuwEoqD-z-70",
            authDomain: "mmauction-a9e40.firebaseapp.com",
            projectId: "mmauction-a9e40",
            storageBucket: "mmauction-a9e40.firebasestorage.app",
            messagingSenderId: "501330031400",
            appId: "1:501330031400:web:5e6ed6eab0ada3350ad61d",
            measurementId: "G-WH0JED6C60"
        };

        function initFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                docRef = db.collection("draft_game").doc("room1");
                
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        globalState = doc.data();
                        renderAll(globalState);
                    } else {
                        resetAllDB(); 
                    }
                }, (error) => alert("DB ì—°ê²° ì‹¤íŒ¨: " + error.message));
            } catch (e) { alert(e.message); }
        }

        window.onload = () => {
            createEmptySlots('team-a', 4);
            createEmptySlots('team-b', 4);
            initFirebase();
        };

        function joinAs(role) {
            myRole = role;
            document.getElementById('login-modal').classList.remove('show');
            document.body.className = `role-${role} p-4 max-w-7xl mx-auto h-screen flex flex-col`;
            
            let roleName = role === 'team-a' ? 'Team A' : (role === 'team-b' ? 'Team B' : 'ê´€ì „ì');
            if(docRef && globalState) {
                docRef.update({ chats: firebase.firestore.FieldValue.arrayUnion({
                    sender: 'System', msg: `${roleName}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`, role: 'system', timestamp: Date.now()
                })});
            }
        }

        function renderAll(data) {
            if(!data) return;
            const loading = document.getElementById('loading-msg');
            if(loading) loading.style.display = 'none';

            if(data.settings) {
                const s = data.settings;
                document.getElementById('display-team-a-name').textContent = s.teamA.name || "-";
                document.getElementById('display-team-a-leader').textContent = `ê°ë…: ${s.teamA.leader || "-"}`;
                document.getElementById('display-team-a-point').textContent = s.teamA.points.toLocaleString();
                document.getElementById('display-team-b-name').textContent = s.teamB.name || "-";
                document.getElementById('display-team-b-leader').textContent = `ê°ë…: ${s.teamB.leader || "-"}`;
                document.getElementById('display-team-b-point').textContent = s.teamB.points.toLocaleString();

                if(document.activeElement.tagName !== 'INPUT') {
                    document.getElementById('start-point-input').value = s.startPoint;
                    document.getElementById('input-team-a-name').value = s.teamA.name;
                    document.getElementById('input-team-a-leader').value = s.teamA.leader;
                    document.getElementById('input-team-b-name').value = s.teamB.name;
                    document.getElementById('input-team-b-leader').value = s.teamB.leader;
                }
            }

            if(data.slots) {
                updateSlots('team-a', data.slots.teamA);
                updateSlots('team-b', data.slots.teamB);
            }

            const poolContainer = document.getElementById('candidate-pool-container');
            poolContainer.innerHTML = '';
            if(data.pool) data.pool.forEach((url, idx) => {
                const div = document.createElement('div');
                div.className = 'card-slot';
                div.style.backgroundImage = `url('${url}')`;
                // ë£°ë › ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìœ¼ë¯€ë¡œ ì§ì ‘ í´ë¦­ ì œê±° (ë˜ëŠ” ìœ ì§€í•˜ë ¤ë©´ ì•„ë˜ ì¤„ ì£¼ì„ í•´ì œ)
                // if(myRole !== 'spectator') div.onclick = () => startAuctionDB(url, idx);
                poolContainer.appendChild(div);
            });

            const modal = document.getElementById('bidding-modal');
            const activeDiv = document.getElementById('controls-active');
            const lockedDiv = document.getElementById('controls-locked');
            const btnAcceptA = document.getElementById('btn-accept-a');
            const btnAcceptB = document.getElementById('btn-accept-b');
            const badge = document.getElementById('high-bidder-badge');

            if(data.auction && data.auction.active) {
                modal.classList.add('show');
                document.getElementById('bidding-player-img').style.backgroundImage = `url('${data.auction.targetUrl}')`;
                document.getElementById('display-bid-price').textContent = data.auction.currentBid.toLocaleString();
                
                const lastBidder = data.auction.lastBidder;

                if(lastBidder === 'team-a') {
                    badge.textContent = "Highest: Team A";
                    badge.className = "absolute top-2 right-2 px-2 py-1 bg-purple-600 text-[10px] rounded text-white font-bold";
                } else if(lastBidder === 'team-b') {
                    badge.textContent = "Highest: Team B";
                    badge.className = "absolute top-2 right-2 px-2 py-1 bg-blue-600 text-[10px] rounded text-white font-bold";
                } else {
                    badge.textContent = "No Bids Yet";
                    badge.className = "absolute top-2 right-2 px-2 py-1 bg-gray-600 text-[10px] rounded text-white";
                }

                if(myRole !== 'spectator') {
                    if(lastBidder === myRole) {
                        activeDiv.classList.add('hidden');
                        lockedDiv.classList.remove('hidden');
                    } 
                    else {
                        lockedDiv.classList.add('hidden');
                        activeDiv.classList.remove('hidden');
                        btnAcceptA.classList.add('hidden');
                        btnAcceptB.classList.add('hidden');
                        if(lastBidder === 'team-a' && myRole === 'team-b') btnAcceptA.classList.remove('hidden');
                        else if(lastBidder === 'team-b' && myRole === 'team-a') btnAcceptB.classList.remove('hidden');
                    }
                }

            } else {
                modal.classList.remove('show');
                document.getElementById('manual-bid-input').value = '';
            }

            const logContainer = document.getElementById('event-log-content');
            let logHtml = '';
            if(data.logs) data.logs.slice(-20).forEach(log => { logHtml += `<div>${log}</div>`; });
            logContainer.innerHTML = logHtml; logContainer.scrollTop = logContainer.scrollHeight;

            renderChat(data.chats || []);
        }

        function renderChat(chats) {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            chats.slice(-50).forEach(chat => {
                const div = document.createElement('div');
                const isMe = (myRole === chat.role);
                let badgeClass = 'badge-spec'; let badgeText = 'ê´€ì „';
                if(chat.role === 'team-a') { badgeClass = 'badge-team-a'; badgeText = 'Team A'; }
                if(chat.role === 'team-b') { badgeClass = 'badge-team-b'; badgeText = 'Team B'; }
                if(chat.role === 'system') { badgeClass = 'bg-yellow-600 text-white'; badgeText = 'System'; }

                div.className = `chat-bubble ${isMe ? 'my' : 'other'}`;
                div.innerHTML = `<div class="flex items-center mb-1"><span class="chat-badge ${badgeClass}">${badgeText}</span><span class="text-[10px] opacity-50">${chat.sender}</span></div><div>${chat.msg}</div>`;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendChatDB() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            let senderName = 'ê´€ì „ì';
            if(myRole === 'team-a') senderName = document.getElementById('input-team-a-leader').value || 'AíŒ€ì¥';
            if(myRole === 'team-b') senderName = document.getElementById('input-team-b-leader').value || 'BíŒ€ì¥';

            docRef.update({ chats: firebase.firestore.FieldValue.arrayUnion({
                sender: senderName, role: myRole, msg: msg, timestamp: Date.now()
            })}).then(() => { input.value = ''; input.focus(); });
        }

        function submitManualBid() {
            if(!globalState.auction.active) return;
            const input = document.getElementById('manual-bid-input');
            const bidAmount = parseInt(input.value);
            const currentBid = globalState.auction.currentBid;

            if(isNaN(bidAmount)) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");
            if(bidAmount <= currentBid) return alert(`í˜„ì¬ê°€(${currentBid})ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`);

            docRef.update({
                "auction.currentBid": bidAmount,
                "auction.lastBidder": myRole, 
                logs: firebase.firestore.FieldValue.arrayUnion(`ğŸ”¥ [ì…ì°°] ${bidAmount.toLocaleString()} í¬ì¸íŠ¸ ì œì‹œë¨!`)
            });
            
            let senderName = myRole === 'team-a' ? 'AíŒ€' : 'BíŒ€';
            sendSystemMessage(`${senderName}ì´(ê°€) ${bidAmount.toLocaleString()} í¬ì¸íŠ¸ë¡œ ê°€ê²©ì„ ì˜¬ë ¸ìŠµë‹ˆë‹¤!`);
            input.value = ''; 
        }

        function sendSystemMessage(text) {
            docRef.update({ chats: firebase.firestore.FieldValue.arrayUnion({
                sender: 'System', role: 'system', msg: text, timestamp: Date.now()
            })});
        }

        function updateSlots(id, slotData) {
            const container = document.getElementById(`slots-${id}`);
            container.innerHTML = '';
            for(let i=0; i<4; i++) {
                const div = document.createElement('div');
                div.className = 'slot-circle';
                if(slotData[i]) { div.style.backgroundImage = `url('${slotData[i]}')`; div.classList.add('drafted'); }
                else { div.innerHTML = `<svg class="w-5 h-5 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>`; }
                container.appendChild(div);
            }
        }
        function createEmptySlots(id, count) { updateSlots(id, []); }

        function updateSettingsDB() {
            if(myRole === 'spectator') return;
            const sp = parseInt(document.getElementById('start-point-input').value);
            docRef.update({
                "settings.startPoint": sp,
                "settings.teamA.name": document.getElementById('input-team-a-name').value,
                "settings.teamA.leader": document.getElementById('input-team-a-leader').value,
                "settings.teamA.points": sp,
                "settings.teamB.name": document.getElementById('input-team-b-name').value,
                "settings.teamB.leader": document.getElementById('input-team-b-leader').value,
                "settings.teamB.points": sp,
                logs: firebase.firestore.FieldValue.arrayUnion(`[ì„¤ì •] ë³€ê²½ë¨`)
            });
        }

        function resetAllDB() {
            docRef.set({
                settings: { startPoint: 1000, teamA: { name: "", leader: "", points: 1000 }, teamB: { name: "", leader: "", points: 1000 } },
                slots: { teamA: [], teamB: [] }, pool: [],
                auction: { active: false, targetUrl: "", currentBid: 0, targetIdx: -1, lastBidder: null },
                logs: ["ì‹œìŠ¤í…œ ì‹œì‘"], chats: []
            });
        }

        function restartGameDB() {
            if(myRole === 'spectator') return;
            if(!confirm("ì¬ì‹œì‘?")) return;
            const sp = parseInt(document.getElementById('start-point-input').value);
            docRef.update({
                settings: { startPoint: sp, teamA: { name: document.getElementById('input-team-a-name').value, leader: document.getElementById('input-team-a-leader').value, points: sp }, teamB: { name: document.getElementById('input-team-b-name').value, leader: document.getElementById('input-team-b-leader').value, points: sp } },
                slots: { teamA: [], teamB: [] },
                auction: { active: false, targetUrl: "", currentBid: 0, targetIdx: -1, lastBidder: null },
                logs: firebase.firestore.FieldValue.arrayUnion("ğŸ”„ ì¬ì‹œì‘ë¨"), chats: []
            });
        }

        document.getElementById('pool-file-input').addEventListener('change', (e) => {
            if(myRole === 'spectator') return;
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => docRef.update({ pool: firebase.firestore.FieldValue.arrayUnion(evt.target.result) });
                reader.readAsDataURL(file);
            });
            docRef.update({ logs: firebase.firestore.FieldValue.arrayUnion(`[ì‚¬ì§„] ì¶”ê°€ë¨`) });
            e.target.value = '';
        });

        function startAuctionDB(url, idx) {
            if(globalState.auction.active) return alert("ê²½ë§¤ ì§„í–‰ ì¤‘");
            docRef.update({
                auction: { active: true, targetUrl: url, currentBid: 0, targetIdx: idx, lastBidder: null },
                logs: firebase.firestore.FieldValue.arrayUnion(`ğŸ“¢ ê²½ë§¤ ì‹œì‘!`)
            });
            sendSystemMessage("ğŸ“¢ ê²½ë§¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì…ì°°í•´ì£¼ì„¸ìš”.");
        }

        function finishBiddingDB(winningTeamKey) {
            if(!globalState.auction.active) return;
            const cost = globalState.auction.currentBid;
            const currentSlots = globalState.slots[winningTeamKey];
            if(currentSlots.length >= 4) return alert("íŒ€ ìŠ¬ë¡¯ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.");

            const newPool = globalState.pool.filter((_, i) => i !== globalState.auction.targetIdx);
            const newSettings = { ...globalState.settings };
            newSettings[winningTeamKey].points -= cost;
            const tName = newSettings[winningTeamKey].name || (winningTeamKey === 'teamA' ? 'Team A' : 'Team B');

            docRef.update({
                "auction.active": false,
                pool: newPool,
                [`slots.${winningTeamKey}`]: [...currentSlots, globalState.auction.targetUrl],
                settings: newSettings,
                logs: firebase.firestore.FieldValue.arrayUnion(`ğŸ”¨ ${tName} ë‚™ì°°! (-${cost})`)
            });
            sendSystemMessage(`ğŸ‰ ${tName}ì—ì„œ ${cost}í¬ì¸íŠ¸ì— ë‚™ì°°ë°›ì•˜ìŠµë‹ˆë‹¤!`);
        }

        function cancelBiddingDB() {
            docRef.update({ "auction.active": false, logs: firebase.firestore.FieldValue.arrayUnion(`ğŸš« ì·¨ì†Œë¨`) });
            sendSystemMessage("ğŸš« ê²½ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // ==================================================
        // ğŸ° ë£°ë › ê¸°ëŠ¥ (ì‹ ê·œ ì¶”ê°€)
        // ==================================================
        function runRoulette() {
            // ê¶Œí•œ ì²´í¬ (íŒ€ì¥ë§Œ)
            if(myRole === 'spectator') return alert("íŒ€ì¥ë§Œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            
            // ë°ì´í„° ì²´í¬
            if(!globalState.pool || globalState.pool.length === 0) return alert("ëŒ€ê¸° ëª…ë‹¨ì— ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if(globalState.auction.active) return alert("ì´ë¯¸ ê²½ë§¤ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");

            // 1. ë£°ë › ëª¨ë‹¬ ë„ìš°ê¸°
            const rouletteModal = document.getElementById('roulette-modal');
            const rouletteImg = document.getElementById('roulette-img');
            rouletteModal.classList.add('show');

            // 2. ì´ë¯¸ì§€ ëº‘ëº‘ì´ (ì• ë‹ˆë©”ì´ì…˜)
            let counter = 0;
            const maxIterations = 30; // 30ë²ˆ ë°”ë€œ
            const pool = globalState.pool;
            
            const interval = setInterval(() => {
                // ëœë¤ìœ¼ë¡œ ì´ë¯¸ì§€ ë³´ì—¬ì£¼ê¸°
                const r = Math.floor(Math.random() * pool.length);
                rouletteImg.style.backgroundImage = `url('${pool[r]}')`;
                rouletteImg.classList.add('roulette-active'); // íš¨ê³¼
                setTimeout(()=>rouletteImg.classList.remove('roulette-active'), 50);

                counter++;
                
                // 3. ë©ˆì¶¤
                if(counter >= maxIterations) {
                    clearInterval(interval);
                    
                    // ìµœì¢… ë‹¹ì²¨ì ì„ ì • (ëœë¤)
                    const finalIdx = Math.floor(Math.random() * pool.length);
                    const finalUrl = pool[finalIdx];
                    rouletteImg.style.backgroundImage = `url('${finalUrl}')`;
                    rouletteImg.style.borderColor = '#fbbf24'; // ê¸ˆìƒ‰ í…Œë‘ë¦¬
                    
                    // 1ì´ˆ ë’¤ì— ì‹¤ì œ ê²½ë§¤ ì‹œì‘
                    setTimeout(() => {
                        rouletteModal.classList.remove('show');
                        rouletteImg.style.borderColor = '#475569'; // ì›ë³µ
                        startAuctionDB(finalUrl, finalIdx);
                    }, 1000);
                }
            }, 100); // 0.1ì´ˆë§ˆë‹¤ ë°”ë€œ
        }
    </script>
</body>
</html>